<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite"
	xmlns:o="http://omnifaces.org/ui" xmlns:hftl="http://hftl.org"
	xmlns:hf="http://xmlns.jcp.org/jsf/composite/tags"
	xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
	xmlns:of="http://omnifaces.org/functions">

<!-- 
    A tag displaying a list of child entities for custom field value of child entities type
    Makes part of custom field management tag group 

    Attributes
        cft - custom field template containing field definition
        edit - should value be displayed, or edit control be shown
        field - field storing a value - CustomFieldValue type variable only
        entity - entity, custom fields are related to
        messagesId - messages id tag to update for general errors
        updateOnAddEdit - ids of controlls to update uppon data changes (value edit/create/delete)
        disabled - is field non-editable
        prefix - prefix for component to distinguish when used multiple times in the same page (for different entities)
 -->

<ui:composition>

	<o:importFunctions type="org.meveo.model.crm.custom.CustomFieldValue"
		var="cfv" />
	<o:importFunctions
		type="org.meveo.service.base.MeveoValueExpressionWrapper" var="exp" />

	<h:outputText value="#{''}" />
	<c:set var="cfValueHolder"
		value="#{customFieldDataEntryBean.getFieldValueHolderByUUID(entity.uuid)}" />
	<c:set var="fieldPrefix"
		value="#{prefix}_#{fn:replace(cft.code, ' ','_')}_" />
	<c:set var="dlgBinary" value="#{fieldPrefix}_dlgBinary" />

	<hftl:decorateFormField
		label="#{cft.description}#{cft.valueRequired?' *':''}"
		componentWidth="#{componentWidth}" displayOneLine="false">

		<p:messages id="#{fieldPrefix}_cfMessages" globalOnly="false"
			redisplay="false" />

		<p:dataTable id="#{fieldPrefix}_customFields_binaries" lazy="false"
			editable="#{edit and !disabled}" editMode="cell" reflow="false"
			resizableColumns="true" rowIndexVar="rowIndex"
			value="#{field.mapValuesForGUI}" var="path">

			<p:column headerText="#{messages['customFieldTemplate.filePath']}">
				<h:outputText title="#{path['value']}"
					value="#{of:abbreviate(path['value'], 25)}"></h:outputText>
			</p:column>

			<p:column headerText="#{messages['commons.actions']}"
				rendered="#{edit and !disabled}" width="15%">
				<p:commandButton ajax="false"
					onclick="PrimeFaces.monitorDownload(start, stop);"
					icon="fa fa-arrow-down" immediate="true">
					<p:fileDownload
						value="#{customFieldDataEntryBean.downloadFile(path['value'])}">
					</p:fileDownload>
				</p:commandButton>
				<p:commandButton icon="ui-icon-minus" partialSubmit="true"
					process="@this" update="#{fieldPrefix}_customFields_binaries"
					action="#{field.listValue.remove(path['value'])}">
					<p:confirm header="#{messages['commons.confirmationHeader']}"
						message="#{messages['commons.confirmDelete']}"
						icon="ui-icon-alert" />
				</p:commandButton>
			</p:column>

			<c:if test="#{!inherited}">
				<f:facet name="footer" layout="block">
					<p:commandButton immediate="true"
						update=":#{p:component(of:concat(fieldPrefix, 'binaryFileUploadForm'))}"
						onclick="PF('#{dlgBinary}').show();"
						value="#{messages['action.uploadBinary']}" />
				</f:facet>
			</c:if>
		</p:dataTable>
	</hftl:decorateFormField>

	<p:dialog id="#{fieldPrefix}#{dlgBinary}" header=""
		widgetVar="#{dlgBinary}" minHeight="300" minWidth="500">
		<h:form id="#{fieldPrefix}binaryFileUploadForm"
			enctype="multipart/form-data" style="width: 100%">
			<p:messages id="#{fieldPrefix}binaryFileUploadMessages"></p:messages>

			<p:panelGrid columns="1" layout="grid" style="width: 500px">
				<hftl:decorateFormField for="#{fieldPrefix}repository"
					label="#{messages['binary.repository']}">
					<p:selectOneMenu id="#{fieldPrefix}repository" required="true"
						value="#{customFieldDataEntryBean.repository}">
						<hftl:objectConverter />
						<f:selectItem itemValue="#{null}" itemLabel="" />
						<f:selectItems value="#{repositoryListBean.listActive()}" var="e"
							itemValue="#{e}" itemLabel="#{e.code}" />
						<p:ajax update="@form" process="@this"></p:ajax>
					</p:selectOneMenu>
				</hftl:decorateFormField>
				<hftl:decorateFormField for="#{fieldPrefix}showOnExplorer"
					label="#{messages['binary.showOnExplorer']}">
					<p:selectBooleanButton id="#{fieldPrefix}showOnExplorer"
						value="#{customFieldDataEntryBean.showOnExplorer}"
						onLabel="#{messages['commons.yes']}"
						offLabel="#{messages['commons.no']}" style="width:60px">
						<p:ajax update="@form" process="@this"></p:ajax>
					</p:selectBooleanButton>
				</hftl:decorateFormField>
				<p:fileUpload id="#{fieldPrefix}fileUpload" immediate="true"
					sequential="true"
					process="@this, #{fieldPrefix}repository, #{fieldPrefix}showOnExplorer"
					required="#{cft.valueRequired and !hasInheritedValue}"
					rendered="#{edit and !disabled}" label="#{cft.description}"
					fileUploadListener="#{customFieldDataEntryBean.handleFileUpload}"
					mode="advanced" dragDropSupport="false" multiple="true"
					oncomplete="PF('#{dlgBinary}').hide();"
					sizeLimit="#{cft.getMaxFileSizeAllowedInBytes()}"
					update="#{fieldPrefix}binaryFileUploadForm :#{p:component(of:concat(fieldPrefix, '_customFields_binaries'))}">
					<f:attribute name="uuid" value="#{entity.uuid}" />
					<f:attribute name="cetCode" value="#{entity.cetCode}" />
					<f:attribute name="cft" value="#{cft}" />
					<f:attribute name="cfv" value="#{field}" />
					<f:attribute name="isSingle" value="false" />
				</p:fileUpload>
			</p:panelGrid>
		</h:form>
	</p:dialog>
</ui:composition>

</html>